<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Slink2Dali" href="slink2dali.html" /><link rel="prev" title="sender-frontend" href="sender-frontend.html" />

    <link rel="shortcut icon" href="_static/upri-favicon.ico"/><!-- Generated with Sphinx 8.0.2 and Furo 2024.08.06 -->
        <title>RingServer - UPRI EarthquakeHub Documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-header-background: #3a6a50;
  --color-header-text: #fcfbf3;
  --color-sidebar-link-text--top-level: #3a6a50;
  --color-background-primary: #fcfbf3;
  --color-background-secondary: #f1f1e8;
  --color-link: #225ebc;
  --color-toc-item-text--hover: fcfbf3;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-header-background: #3a6a50;
  --color-header-text: #d9e8e5;
  --color-sidebar-link-text--top-level: #3a6a50;
  --color-link: #00b0ff;
  --color-background-secondary: #28292a;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-header-background: #3a6a50;
  --color-header-text: #d9e8e5;
  --color-sidebar-link-text--top-level: #3a6a50;
  --color-link: #00b0ff;
  --color-background-secondary: #28292a;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">UPRI EarthquakeHub Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="_static/upri-logo-92x92.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">UPRI EarthquakeHub Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="connect-to-rshake.html">How to Connect to Your Raspberry Shake via SSH</a></li>
<li class="toctree-l1"><a class="reference internal" href="installing-rshake-client.html">Installing EarthquakeHub Client on Raspberry Shake</a></li>
<li class="toctree-l1"><a class="reference internal" href="sending-data-to-ehub-network.html">Sending Data to EarthquakeHub Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="acquiring-new-token.html">Acquiring New Token for your rShake Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="fdsnws.html">How to Use FDSNWS to Download Ground Motion Data and Station Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-metadata-using-python.html">Programmatically Getting the Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro-to-seiscomp.html">Introduction To SeisComp</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-guide-contributing.html">Developer Guide: Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker-cheatsheet.html">Developer Guide: Docker Cheatsheet</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="system-overview.html">System Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="ehub-commons.html">earthquake-hub-commons</a></li>
<li class="toctree-l1"><a class="reference internal" href="ehub-backend/overview.html">earthquake-hub-backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="ehub-frontend.html">earthquake-hub-frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="sender-backend/overview.html">sender-backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="sender-frontend.html">sender-frontend</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">RingServer</a></li>
<li class="toctree-l1"><a class="reference internal" href="slink2dali.html">Slink2Dali</a></li>
<li class="toctree-l1"><a class="reference internal" href="significant-eqs.html">Significant Earthquakes in UPRI Citizen Science Seismic Network</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Issues</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="issues/rshake-ntp-issue.html">RShake NTP Timing Issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="issues/blank-rs.local-page.html">Blank rs.local Page Due to 100% Utilization of Device Storage</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/ringserver.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="ringserver">
<h1>RingServer<a class="headerlink" href="#ringserver" title="Link to this heading">¶</a></h1>
<p>This documentation aims to introduce the application of RingServer in the earthquake-hub citizen science network. See the <a href="https://upri-earthquake.github.io/system-overview" target="_blank">system overview here</a>. This is a fork of <a href="https://github.com/EarthScope/ringserver" target="_blank">EarthScope/RingServer</a>.See their <a href="https://github.com/EarthScope/ringserver/blob/main/doc/ringserver.md" target="_blank">original documentation here</a>.</p>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">¶</a></h2>
<p>There are various application-level communication protocols used in seismological data transmission, such are the SeedLink and DataLink protocols. The main goal of such protocols is to provide communication rules to transfer time series data from a source (such as file-archives or real-time digital sensors) towards a destination (such as a processing software or a data server).</p>
<p>The <a href="https://www.seiscomp.de/seiscomp3/doc/applications/seedlink.html" target="_blank">SeedLink</a> and <a href="https://seiscode.iris.washington.edu/svn/orb2ringserver/tags/release-1.0/libdali/doc/DataLink.protocol" target="_blank">DataLink</a> protocols both follow server-client paradigm. However there is a clear distinction in that the SeedLink protocol is a one-way stream communication from the server to the client. That is, the client initiates connection, requests a specific stream, and receives real-time or archived data stream. On the other hand, DataLink protocol can facilitate streaming of data from either direction: client to server, or server to client. That means, after initiating a connection, a client can negotiate a stream it wants, and either receive that data stream or send that data stream (given that this client has a source of data). (add connection diagram here for SeedLink and DataLink server, showing that a client in DataLink can be on both side, sender and receiver).</p>
<p>RingServer is one example of a server that utilizes the DataLink protocol as a server of time-series data. On the other hand, slink2dali and dalitool are examples of DataLink clients.</p>
</section>
<section id="what-it-does">
<h2>What It Does<a class="headerlink" href="#what-it-does" title="Link to this heading">¶</a></h2>
<p>A RingServer utilizes a given communication protocol to take in time-series data, write it on a ring buffer, and serve that data (or diagnostics of such data) towards the clients. It can perform these via SeedLink, DataLink, or HTTP (WebSocket) protocols.</p>
</section>
<section id="how-it-works">
<h2>How It Works<a class="headerlink" href="#how-it-works" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Running the program will start the main thread called ListenThread which listens on a socket waiting for a TCP client to connect.</p></li>
<li><p>Each new connection is handled on a new thread called ClientThread where the responses to the requests or commands from the client are handled mostly by that new thread. There are three types of clients, one for each protocol: DataLink, SeedLink, and HTTP.</p></li>
<li><p>In the case that a client sends a command to write a packet via the DataLink protocol, the execution will call <code class="docutils literal notranslate"><span class="pre">HandleWrite()</span></code> where the command message and the packet itself will undergo some checks before being written into the ring buffer via the <code class="docutils literal notranslate"><span class="pre">RingWrite()</span></code> function.</p></li>
</ol>
<p>To have a better grasp of how this works, it’s important to understand the data structure used (ring buffer) and how it is used in this application.</p>
<p>In particular, the ring buffer is chosen as the data structure in which incoming packets are to be stored. In the context of our use case, it suffices to think of it simply as an array where the end wraps around to the beginning, creating a circular structure. This is such that when we write data into this array and reach the end, we then start overwriting what had been previously written on the beginning of the array.  This can be achieved via modulo addressing, meaning given an index value that is sequentially incremented to access the array values, when this value exceeds the length of the array, using modulo addressing would instead result for the index value to return to the beginning.</p>
<p>We can see how this results to a desirable property as a temporary receptacle (buffer) for non-stop data streams: the ring structure can be given a size that wouldn’t grow over time as we write more data due to the built-in feature of overwriting old data.</p>
<p><img alt="image" src="_images/6.1.jpg" /></p>
<p>Lastly, this ring is treated as a shared memory between threads who write into and read from it. A connection from a client corresponds to a single thread, and a single thread can write multiple packets into the ring buffer. In particular, the data in the ring buffer is organized into streams, identified by a unique <code class="docutils literal notranslate"><span class="pre">streamid</span></code> with the format <code class="docutils literal notranslate"><span class="pre">NET_STAT_LOC_CHANNEL</span></code>. Each stream represents a time-series data recording of a single axis of motion from a station belonging to a network. To represent a stream of data within the ring buffer, a linked-list data structure is used. Each value in the linked-list points to the location in the ring buffer where the next data point of that specific stream is stored.</p>
</section>
<section id="changes">
<h2>Changes<a class="headerlink" href="#changes" title="Link to this heading">¶</a></h2>
<ol class="arabic">
<li><p><strong>Authorization</strong></p>
<p>Being able to control which clients can connect to a server is a useful feature in server management. More so when you allow clients to write data into your server, it is necessary to discriminate among clients based on whether they have write permissions or not. Originally, RingServer can discriminate client connections via manually written IP addresses in the server configuration file (see original <code class="docutils literal notranslate"><span class="pre">TrustedIP</span></code> configuration on original documentation). However, in citizen science application, there is no way to identify user IP address pre-connection since IP addresses are often dynamic and hidden behind Network Address Translation (NAT).</p>
<p>To solve this problem we used JSON web tokens (JWT) and an <a class="reference external" href="https://alyssapatricia.github.io/ui/ehub-backend/api-docs/">external Authentication API</a>, to identify whether a client requesting to write data into the RingServer has permission or not. The way this works is:</p>
<p>a. We added the AUTHORIZATION command in the DataLink protocol, with the following format:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="w">  </span>AUTHORIZATION<span class="w"> </span>size<span class="se">\r\n</span><span class="w"> </span><span class="o">[</span>token<span class="o">]</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>where token is a JWT of the client requesting WRITE permission, and size is the size of that token in bytes.
</pre></div>
</div>
<p>b. This provided token is forwarded by the RingServer to the <code class="docutils literal notranslate"><span class="pre">AuthServer</span></code>. The value of this config variable should be set in <code class="docutils literal notranslate"><span class="pre">ring.conf</span></code> and should be given the HTTPS address of the Authentication API from which the client and the RingServer are registered in.</p>
<p>c. In response, the AuthServer will handle the decoding and verification of the token, providing essential streamIDs and other relevant information associated with the token. Subsequently, the RingServer will designate the client connection as a write-authorized connection, specifically granting write permissions on the mentioned streamIDs.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="w">  </span>/*<span class="w"> </span>Response<span class="w"> </span>schema<span class="w"> </span>of<span class="w"> </span>AuthServer,<span class="w"> </span>received<span class="w"> </span>by<span class="w"> </span>RingServer<span class="w"> </span>*/
<span class="w">  </span><span class="o">{</span>
<span class="w">    </span>status:<span class="w"> </span>responseCodes.INBEHALF_VERIFICATION_SUCCESS,
<span class="w">    </span>message:<span class="w"> </span><span class="s1">&#39;Sensor is a valid streamer&#39;</span>,
<span class="w">    </span>sensorInfo:<span class="w"> </span><span class="o">{</span>
<span class="w">      </span>username:<span class="w"> </span>decodedToken.username,
<span class="w">      </span>role:<span class="w"> </span>decodedToken.role,
<span class="w">      </span>streamIds:<span class="w"> </span>sensorStreamIds,<span class="w">   </span>//<span class="w"> </span>based<span class="w"> </span>on<span class="w"> </span>username<span class="err">&#39;</span>s<span class="w"> </span>registered<span class="w"> </span>WRITE<span class="w"> </span>permissions
<span class="w">      </span>tokenExp:<span class="w"> </span>decodedToken.exp,
<span class="w">    </span><span class="o">}</span>
<span class="w">  </span><span class="o">}</span>
</pre></div>
</div>
<p>d. Once authorized, the client gains the ability to successfully execute WRITE commands on the RingServer, specifically limited to the assigned streamIDs. In the event that the client lacks authorization, the connection will be closed. Additionally, if an authorized client attempts to write on streamIDs other than those with granted permissions, the RingServer will drop the packets.</p>
<p><img alt="image" src="_images/6.2.jpg" />.</p>
<p>This approach requires clients to register beforehand if they want to be allowed write access into the RingServer. Such is a service provided by the Authentication API (AuthServer) which can be run as an external HTTPS server that can provide tokens for any registered client and can verify tokens for any <em>registered</em> RingServer. In the context of the earthquake-hub citizen science network, UPRI is hosting this Authentication API.</p>
<p>RingServer’s requesting token verification in behalf of a client should themselves also be registered through the Authentication API. This is done so as to maintain that all nodes (client or server) within the citizen science network are registered users that are all managed within the central Authentication Server.</p>
</li>
<li><p><strong>Redundant Connections</strong></p>
<p>The dual nature of a DataLink connection allows for more complex network structures. Specifically in the citizen science network, a client can choose to send data to multiple publicly available RingServers which themselves can also forward their data to other RingServers. In such a scenario, a redundant connection is possible if a source of data establishes a direct and an indirect connection such as shown in the diagram:
<img alt="image" src="_images/redundant.jpg" /></p>
<p>Such a redundant connection is actually tolerated so as to improve network data resiliency and to allow more localized event detection<a class="footnote-reference brackets" href="#id2" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p>
<p>A problem that will arise from allowing redundant connections is that the RingServer at the last receiving end will receive packets from the same source once for every connection. Hence, it should be able to identify duplicate packets for a given stream and perform necessary action. In this case, we decided that it is simplest to just drop the packets (or not proceed on writing them into the ring and just move to the next available packet) so as to avoid having duplicate packets written on the ring.</p>
<p>To do this, a function <code class="docutils literal notranslate"><span class="pre">CheckIfDuplicate()</span></code> was created to act as a filter on new packets, checking whether the packet is duplicate or not. This function is called before <code class="docutils literal notranslate"><span class="pre">RingWrite()</span></code>. The only basis used on deciding whether to write the new packet or not is by checking whether data <em>start-time of the packe</em>t  is later or equal to the <em>end-time of the latest written packet</em> in the stream that the packet belongs to.</p>
<p><em>(This is a very simplistic approach and might require further improvements if need be; however, this solution can be used in this application since a packet’s start-time and end-time both depends on the source data packet, i.e. a miniseed packet. That means that all packets coming from a single source and received on each different connection will have start and end times that are based on the same time source, meaning it is plausible to perform comparison between them and use this to decide time-ordering of the packets(footnote: one special case is that identical packets shall also have identical start and end times and hence can be concluded on the receiving end to be duplicates)</em></p>
<p>It should be mentioned that similar to the original RingServer, no packet re-ordering is performed in this fork. The packets that are coming are all received and written in the order they are received, with the difference that now we’re dropping the packet if it fails the duplicate checking.</p>
</li>
<li><p><strong>Server-Sent-Events (SSE) Endpoints</strong></p>
<p>Real-time monitoring of data and connection status is a useful feature in programs like the RingServer. The original implementation provided the <code class="docutils literal notranslate"><span class="pre">/streams</span></code> and <code class="docutils literal notranslate"><span class="pre">/connections</span></code> HTTP endpoints to serve stream data time ranges on the ring buffer and client connection diagnostics, respectively. These are available on a per-request basis, and hence if one wanted to perform real-time monitoring with these information, the simplest approach would be to perform polling on these endpoints.</p>
<p>However, in our application, it is necessary that the consumer of these status updates should not be the one triggering these requests. Moreover, we require that this information be served in JSON format. To address these requirements, we have decided to implement Server-Sent Events (SSE) by adding additional endpoints, namely <code class="docutils literal notranslate"><span class="pre">/sse-streams</span></code> and <code class="docutils literal notranslate"><span class="pre">/sse-connections</span></code>. These endpoints will serve the required information in JSON format, and the RingServer will push updates to the clients at a fixed rate. SSE functions similarly to a WebSocket connection, but it differs in that it sends data only in one direction: from the server to the client.</p>
<p>The following are example messages for each of the SSE endpoint.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>event:<span class="w"> </span>ringserver-streamids-status<span class="se">\n</span>
data:
<span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;stream_ids&quot;</span>:<span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;stream_id&quot;</span>:<span class="s2">&quot;AM_RE722_00_EHZ/MSEED&quot;</span>,
<span class="w">        </span><span class="s2">&quot;earliest_data_start_time&quot;</span>:<span class="s2">&quot;2023-06-27T11:30:51.183000Z&quot;</span>,
<span class="w">        </span><span class="s2">&quot;latest_data_end_time&quot;</span>:<span class="s2">&quot;2023-06-27T12:16:40.493000Z&quot;</span>
<span class="w">    </span><span class="o">}</span>,
<span class="w">    </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;stream_id&quot;</span>:<span class="s2">&quot;GE_TOLI2__BHE/MSEED&quot;</span>,
<span class="w">        </span><span class="s2">&quot;earliest_data_start_time&quot;</span>:<span class="s2">&quot;2023-05-30T11:21:37.069538Z&quot;</span>,
<span class="w">        </span><span class="s2">&quot;latest_data_end_time&quot;</span>:<span class="s2">&quot;2023-06-09T10:15:00.969538Z&quot;</span>
<span class="w">    </span><span class="o">}]</span>,
<span class="w">   </span><span class="s2">&quot;current_time&quot;</span>:<span class="w"> </span><span class="s2">&quot;2023-07-06 08:19:20.833048&quot;</span>
<span class="w"> </span><span class="o">}</span>
<span class="w"> </span><span class="se">\n\n</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>event:<span class="w"> </span>ringserver-connections-status<span class="se">\n</span>
data:
<span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;connections&quot;</span>:<span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;protocol&quot;</span>:<span class="w"> </span><span class="s2">&quot;Unknown&quot;</span>,
<span class="w">        </span><span class="s2">&quot;connection_time&quot;</span>:<span class="w"> </span><span class="s2">&quot;2023-07-06 08:19:20.733105&quot;</span>,
<span class="w">        </span><span class="s2">&quot;hostname&quot;</span>:<span class="w"> </span><span class="s2">&quot;localhost&quot;</span>,
<span class="w">        </span><span class="s2">&quot;username&quot;</span>:<span class="w"> </span><span class="s2">&quot;none&quot;</span>,
<span class="w">        </span><span class="s2">&quot;role&quot;</span>:<span class="w"> </span><span class="s2">&quot;none&quot;</span>,
<span class="w">        </span><span class="s2">&quot;num_rx_packets&quot;</span>:<span class="w"> </span><span class="s2">&quot;0&quot;</span>,
<span class="w">        </span><span class="s2">&quot;rx_packets_per_sec&quot;</span>:<span class="w"> </span><span class="s2">&quot;0.0&quot;</span>,
<span class="w">        </span><span class="s2">&quot;num_rx_bytes&quot;</span>:<span class="w"> </span><span class="s2">&quot;0&quot;</span>,
<span class="w">        </span><span class="s2">&quot;rx_bytes_per_sec&quot;</span>:<span class="w"> </span><span class="s2">&quot;0.0&quot;</span>,
<span class="w">        </span><span class="s2">&quot;lag_ms&quot;</span>:<span class="w"> </span><span class="s2">&quot;0.1&quot;</span>,
<span class="w">        </span><span class="s2">&quot;stream_count&quot;</span>:<span class="w"> </span><span class="s2">&quot;0&quot;</span>,
<span class="w">        </span><span class="s2">&quot;stream_ids&quot;</span>:<span class="w"> </span><span class="o">[]</span>
<span class="w">    </span><span class="o">}</span>,
<span class="w">    </span><span class="o">{</span>
<span class="w">        </span><span class="s2">&quot;protocol&quot;</span>:<span class="w"> </span><span class="s2">&quot;DataLink&quot;</span>,
<span class="w">        </span><span class="s2">&quot;connection_time&quot;</span>:<span class="w"> </span><span class="s2">&quot;2023-07-06 08:14:23.009189&quot;</span>,
<span class="w">        </span><span class="s2">&quot;hostname&quot;</span>:<span class="w"> </span><span class="s2">&quot;localhost&quot;</span>,
<span class="w">        </span><span class="s2">&quot;username&quot;</span>:<span class="w"> </span><span class="s2">&quot;citizen&quot;</span>,
<span class="w">        </span><span class="s2">&quot;role&quot;</span>:<span class="w"> </span><span class="s2">&quot;sensor&quot;</span>,
<span class="w">        </span><span class="s2">&quot;num_rx_packets&quot;</span>:<span class="w"> </span><span class="s2">&quot;206&quot;</span>,
<span class="w">        </span><span class="s2">&quot;rx_packets_per_sec&quot;</span>:<span class="w"> </span><span class="s2">&quot;1.0&quot;</span>,
<span class="w">        </span><span class="s2">&quot;num_rx_bytes&quot;</span>:<span class="w"> </span><span class="s2">&quot;105472&quot;</span>,
<span class="w">        </span><span class="s2">&quot;rx_bytes_per_sec&quot;</span>:<span class="w"> </span><span class="s2">&quot;511.8&quot;</span>,
<span class="w">        </span><span class="s2">&quot;lag_ms&quot;</span>:<span class="w"> </span><span class="s2">&quot;0.2&quot;</span>,
<span class="w">        </span><span class="s2">&quot;stream_count&quot;</span>:<span class="w"> </span><span class="s2">&quot;16&quot;</span>,
<span class="w">        </span><span class="s2">&quot;stream_ids&quot;</span>:<span class="w"> </span><span class="o">[</span><span class="s2">&quot;GE_TOLI2_.*/MSEED&quot;</span>,<span class="s2">&quot;AM_RE722_.*/MSEED&quot;</span><span class="o">]</span>
<span class="w">    </span><span class="o">}]</span>,
<span class="w">    </span><span class="s2">&quot;current_time&quot;</span>:<span class="w"> </span><span class="s2">&quot;2023-07-06 08:19:20.833048&quot;</span>,
<span class="w">     </span><span class="s2">&quot;num_selected_connections&quot;</span>:<span class="w"> </span><span class="s2">&quot;5&quot;</span>,
<span class="w">     </span><span class="s2">&quot;total_num_connections&quot;</span>:<span class="w"> </span><span class="s2">&quot;5&quot;</span>
<span class="o">}</span>
<span class="se">\n\n</span>
</pre></div>
</div>
</li>
<li><p><strong>Docker &amp; Dependency Additions</strong></p>
<p>The features added in this fork required additional dependencies, namely <code class="docutils literal notranslate"><span class="pre">jansson</span></code> and <code class="docutils literal notranslate"><span class="pre">curl</span></code>. We have opted to include these as built-in dependencies to simplify the process of building this forked version from source. This decision also makes it easier to build it into a docker image, which is particularly beneficial for our application, as we utilize Docker Compose for both development and deployment of our microservices.</p>
</li>
</ol>
</section>
<section id="contributing-md">
<h2>CONTRIBUTING.md<a class="headerlink" href="#contributing-md" title="Link to this heading">¶</a></h2>
<p>This is the link for <a class="reference external" href="https://github.com/UPRI-earthquake/receiver-ringserver/blob/dev/CONTRIBUTING.md">CONTRIBUTING.md</a></p>
</section>
</section>
<hr class="footnotes docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id2" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>In the context of data processing softwares, a RingServer receiving data from a client geographically closer to it than another RingServer should be able to more quickly provide this data to a processor as compared to the other RingServer).</p>
</aside>
</aside>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="slink2dali.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Slink2Dali</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="sender-frontend.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">sender-frontend</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, UPRI
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">RingServer</a><ul>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#what-it-does">What It Does</a></li>
<li><a class="reference internal" href="#how-it-works">How It Works</a></li>
<li><a class="reference internal" href="#changes">Changes</a></li>
<li><a class="reference internal" href="#contributing-md">CONTRIBUTING.md</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>